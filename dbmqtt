import json
import threading
import pymysql
from datetime import datetime, timedelta
import paho.mqtt.client as mqtt


# ---------- MQTT è¨­å®š ----------
BROKER = "192.168.1.8"
PORT = 1883
TOPIC_ADC = "esp32/adc"


# ---------- MySQL è¨­å®š ----------
DB_HOST = "localhost"
DB_USER = "mqttuser"
DB_PASSWORD = "gs5g4432"
DB_NAME = "adc_db"
TABLE_NAME = "adc_data"


# ---------- 500 ç­†ç·©è¡ ----------
data_buffer = []
BATCH_SIZE = 500
batch_count = 0


# ---------- è½‰æ›æ™‚é–“ ----------
def ts_to_datetime(ts_sec, ts_usec):
    ts = ts_sec + ts_usec/1e6
    dt = datetime.utcfromtimestamp(ts) + timedelta(hours=24)  # æ ¡æ­£
    return dt


# ---------- MySQL å¯«å…¥ ----------
def insert_batch(batch):
    if not batch:
        return
    try:
        conn = pymysql.connect(host=DB_HOST, user=DB_USER, password=DB_PASSWORD,
                               database=DB_NAME, charset='utf8mb4')
        cursor = conn.cursor()
        sql = f"INSERT INTO {TABLE_NAME} (timestamp, value, dt_ms) VALUES (%s, %s, %s)"
        values = [(item["timestamp"].strftime("%Y-%m-%d %H:%M:%S.%f"), item["value"], item["dt_ms"]) for item in batch]
        cursor.executemany(sql, values)
        conn.commit()
        cursor.close()
        conn.close()
        print(f"âœ… å¯«å…¥ {len(batch)} ç­†è³‡æ–™")
    except Exception as e:
        print(f"[SQLéŒ¯èª¤] {e}")


# ---------- MQTT å›å‘¼ ----------
def on_connect(client, userdata, flags, rc):
    print("âœ… MQTT Connected:", rc)
    client.subscribe(TOPIC_ADC)


def on_message(client, userdata, msg):
    global data_buffer, batch_count
    payload = msg.payload.decode("utf-8", errors="ignore")
    try:
        batch = json.loads(payload)
        if isinstance(batch, list):
            prev_ts = None
            for item in batch:
                ts = ts_to_datetime(item["ts_sec"], item["ts_usec"])
                value = item["value"]
                # è¨ˆç®— dt (æ¯«ç§’)
                if prev_ts is not None:
                    dt_ms = (ts - prev_ts).total_seconds() * 1000
                else:
                    dt_ms = 0.0
                prev_ts = ts
                data_buffer.append({"timestamp": ts, "value": value, "dt_ms": dt_ms})
               
                # è¶…é 500 ç­†å¯«å…¥ MySQL
                if len(data_buffer) >= BATCH_SIZE:
                    batch_count += 1
                    insert_batch(data_buffer)
                    data_buffer = []
    except Exception as e:
        print(f"[è§£æéŒ¯èª¤] {e}")


# ---------- MQTT åŸ·è¡Œç·’ ----------
def mqtt_thread():
    client = mqtt.Client()
    client.on_connect = on_connect
    client.on_message = on_message
    client.connect(BROKER, PORT, 60)
    client.loop_forever()


# ---------- ä¸»ç¨‹å¼ ----------
if __name__ == "__main__":
    t = threading.Thread(target=mqtt_thread, daemon=True)
    t.start()
    print("ğŸš€ MQTT æ¥æ”¶ç¨‹å¼å•Ÿå‹•")
    t.join()





CREATE DATABASE IF NOT EXISTS adc_db
USE adc_db;
CREATE TABLE	adc_data(
	id INT AUTO_INCREMENT PRIMARY KEY,
	timestamp DATETIME(6),
	`value` FLOAT,
	dt_ms FLOAT 
);

SHOW TABLES;
SELECT *from adc_data LIMIT 2000;


import pymysql
import matplotlib.pyplot as plt
from datetime import datetime

# ---------- MySQL è¨­å®š ----------
DB_HOST = 'localhost'
DB_USER = 'ä½ çš„å¸³è™Ÿ'
DB_PASSWORD = 'ä½ çš„å¯†ç¢¼'
DB_NAME = 'adc_db'
TABLE_NAME = 'adc_data2'

# ---------- é€£ç·š ----------
conn = pymysql.connect(
    host=DB_HOST,
    user=DB_USER,
    password=DB_PASSWORD,
    database=DB_NAME
)

cursor = conn.cursor()

# ---------- è®€å–è³‡æ–™ ----------
# å‡è¨­åªå–æœ€æ–° 500 ç­†
sql = f"SELECT timestamp, value, dt_ms FROM {TABLE_NAME} ORDER BY id DESC LIMIT 500"
cursor.execute(sql)
rows = cursor.fetchall()

conn.close()

# ---------- è§£æè³‡æ–™ ----------
timestamps = []
values = []
dt_list = []

start_time = None
acc_time = 0.0

for row in reversed(rows):  # å¾æœ€èˆŠåˆ°æœ€æ–°
    ts, value, dt = row
    if start_time is None:
        start_time = ts
        acc_time = 0.0
    else:
        acc_time += dt  # ç´¯åŠ  dt
    timestamps.append(acc_time)  # X è»¸: ç´¯ç©æ™‚é–“(ms)
    values.append(value)
    dt_list.append(dt)

# ---------- ç•«åœ– ----------
plt.figure(figsize=(12, 6))
plt.plot(timestamps, values, marker='o', linestyle='-')
plt.xlabel("ç´¯ç©æ™‚é–“ (ms)")
plt.ylabel("ADC Value (mV)")
plt.title("ADC 500 ç­†è³‡æ–™")
plt.grid(True)
plt.show()


